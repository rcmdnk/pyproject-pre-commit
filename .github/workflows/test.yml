---
name: test

on:
  push:
    branches-ignore:
      - "coverage"
      - "renovate/**"
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]];then
            echo "REF=${{ github.event.pull_request.head.sha }}"  >> $GITHUB_ENV
          else
            echo "REF=${{ github.ref }}" >> $GITHUB_ENV
          fi
      - uses: convictional/trigger-workflow-and-wait@v1.6.5
        continue-on-error: true
        id: dispatch
        with:
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          ref: ${{ env.REF }}
          github_token: ${{ github.token }}
          workflow_file_name: dispatch.yml
          propagate_failure: true
      - name: Write workflow url
        run: |
          echo Main job URL: ${{ steps.dispatch.outputs.workflow_url }} >> $GITHUB_STEP_SUMMARY
      - name: Check status
        run: |
          if [ "${{ steps.dispatch.outcome }}" != "success" ];then
            exit 1
          fi
